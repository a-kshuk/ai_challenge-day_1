import GigaChat from "gigachat";
import { ChatMessage, ChatResponse } from "../types";
import { isValidChatResponse } from "../utils/isValidChatResponse";

const SYSTEM_PROMPT = `Ты — специалист по анализу и сжатию диалогов между пользователем и ИИ‑агентом. Твоя задача: создать лаконичное, структурированное резюме диалога, которое позволит любому другому ИИ‑агенту полноценно продолжить общение с пользователем без потери контекста.

Требования к резюме:

Объём: 4–6 предложений (максимум 120 слов).
Обязательные элементы:
основная цель пользователя в этом диалоге;
ключевые вопросы пользователя и ответы ИИ;
достигнутые промежуточные результаты (если есть);
нерешённые вопросы или открытые темы для дальнейшего обсуждения;
важные детали (даты, цифры, имена, термины, предпочтения пользователя).
Стиль: нейтральный, информативный, без канцеляризмов. Избегай оценочных суждений и эмоциональных оттенков.
Структура: единый связный текст без подзаголовков и маркированных списков.
Фокус: сохрани всю информацию, необходимую для бесшовного перехода к другому ИИ‑агенту (он должен понять контекст и продолжить диалог как естественный преемник).`;

/**
 * Отправляет итоговое сообщение, суммирующее историю разговора.
 *
 * @param client Экземпляр GigaChat для взаимодействия с моделью.
 * @param history История предыдущих сообщений.
 * @returns Ответ модели с текстом сообщения и статистикой использования токенов.
 */
export async function sendSummaryMessage(
  client: GigaChat,
  history: ChatMessage[]
): Promise<ChatResponse> {
  const response = await client.chat({
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      ...history.filter(({ role }) => role !== "system"),
    ],
  });

  // Проверка формата ответа и извлечение необходимых полей
  if (isValidChatResponse(response)) {
    return {
      message: response.choices[0].message.content || "Нечего сказать.",
      prompt_tokens: response.usage.prompt_tokens,
      completion_tokens: response.usage.completion_tokens,
    };
  } else {
    throw new Error("Неправильный формат ответа от API");
  }
}
